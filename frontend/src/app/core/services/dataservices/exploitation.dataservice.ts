import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable, map } from 'rxjs';
import { MapFeature } from '../../models/map-feature.model';
import { ConfigurationService } from '../configuration.service';
import { UtilsService } from '../utils.service';
import { CustomWorkOrder, Workorder } from '../../models/workorder.model';

@Injectable({
  providedIn: 'root',
})
export class ExploitationDataService {
  constructor(
    private configurationService: ConfigurationService,
    private http: HttpClient,
    private utilsService: UtilsService
  ) {}

  private httpOptions = {
    headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
  };

  public getFeaturePagination(
    key: string,
    limit: number,
    offset: number,
    search: Map<string, string[]> | undefined
  ): Observable<MapFeature[]> {
    return this.http
      .post<MapFeature[]>(
        `${this.configurationService.apiUrl}exploitation/${key}/pagination/${limit}/${offset}`,
        this.utilsService.mapToJson(search),
        this.httpOptions
      )
      .pipe(map((fs: any[]) => fs.map((f) => MapFeature.from(f))));
  }

  public createWorkOrder(workorder: any): Observable<any> {
    return this.http.post<any>(
      `${this.configurationService.apiUrl}exploitation/workorder/create`,
      workorder,
      this.httpOptions
    );
  }

  /**
   * Get list of workorders for a given asset
   * @returns an observable of the list of workorders
   */
  public getListWorkorders(
    assetId: string,
    assetTable: string
  ): Observable<Workorder[]> {
    return this.http.get<Workorder[]>(
      `${this.configurationService.apiUrl}exploitation/workorder/getlist/${assetId}/${assetTable}`
    );
  }

  /**
   * Get a workorder
   * @returns an observable of the workorder
   */
  public getWorkorderById(id: number): Observable<CustomWorkOrder> {
    return this.http.get<CustomWorkOrder>(
      `${this.configurationService.apiUrl}exploitation/workorder/${id}`
    );
  }
}
