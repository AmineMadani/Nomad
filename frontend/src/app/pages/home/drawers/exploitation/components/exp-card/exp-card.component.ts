import { Component, OnInit, OnDestroy, Input, TemplateRef, Output, EventEmitter } from '@angular/core';
import { Subject } from 'rxjs/internal/Subject';
import { takeUntil } from 'rxjs/internal/operators/takeUntil';
import { MapEventService } from 'src/app/core/services/map/map-event.service';
import { MapFeature } from 'src/app/core/models/map-feature.model';
import { InfiniteScrollCustomEvent, IonContent } from '@ionic/angular';
import { MapService } from 'src/app/core/services/map/map.service';

@Component({
  selector: 'app-exp-card',
  templateUrl: './exp-card.component.html',
  styleUrls: ['./exp-card.component.scss'],
})
export class ExpCardComponent implements OnInit, OnDestroy {
  constructor(
    private mapService: MapService,
    private mapEvent: MapEventService
  ) {
    this.mapEvent
      .onFeatureHovered()
      .pipe(takeUntil(this.ngUnsubscribe$))
      .subscribe((f: string | number | undefined) => {
        if (f) {
          this.featureHovered = f;
          const feature = document.getElementById(
            'feature-' + this.featureHovered
          );
          if (feature) {
            const ionContent: any = document.getElementById(
              'filter-content-scrollable'
            );
            if (ionContent) {
              (ionContent as IonContent).scrollToPoint(
                0,
                feature.offsetTop,
                1000
              );
            }
          }
        } else {
          this.featureHovered = undefined;
        }
      });
  }

  @Input() features: any[];
  @Input() type: string;
  @Input() titleTemplateRef: TemplateRef<any>;
  @Input() subtitleTemplateRef: TemplateRef<any>;
  @Input() labelTemplateRef: TemplateRef<any>;
  @Input() chipTemplateRef: TemplateRef<any>;
  @Input() fromCache: boolean;
  @Input() isLoading: boolean = false;

  @Output() onLoadingEvent: EventEmitter<InfiniteScrollCustomEvent> =
    new EventEmitter();
  @Output() onFeatureSelected: EventEmitter<MapFeature> = new EventEmitter();

  public featureHovered: string | number | undefined;

  private ngUnsubscribe$: Subject<void> = new Subject();

  ngOnInit() {}

  ngOnDestroy(): void {
    this.ngUnsubscribe$.next();
    this.ngUnsubscribe$.complete();
  }

  public trackByFn(index: number, feature: any): number {
    return feature.id;
  }

  public highlightFeature(feature: any | undefined): void {
    if (this.mapService.hasEventLayer('task')) {
      if (feature?.id) {
        this.mapEvent.highlightHoveredFeatures(this.mapService.getMap('home'), [
          { source: 'task', id: feature?.id ?? undefined },
        ]);
      } else {
        this.mapEvent.highlightHoveredFeatures(
          this.mapService.getMap('home'),
          undefined
        );
      }
    }
  }

  public onIonInfinite(ev: any) {
    this.onLoadingEvent.next(ev);
  }

  public openFeature(feature: MapFeature): void {
    this.onFeatureSelected.next(feature);
  }
}
