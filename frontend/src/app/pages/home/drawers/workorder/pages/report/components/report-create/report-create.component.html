<ion-item lines="none" *ngIf="!isTest">
  <ion-button *ngIf="!isMobile" fill="clear" slot="start" (click)="onDrawerBack()">
    <ion-icon size="small" slot="icon-only" name="arrow-back"></ion-icon>
  </ion-button>
  <ion-label class="header-label">Compte-rendu</ion-label>
  <ion-icon *ngIf="workorder.id < 0" size="small" slot="end" name="trash-outline" (click)="onDelete()"></ion-icon>

  <app-attachment [workorder]="workorder"></app-attachment>

  <ion-icon size="small" slot="end" name="close-outline" (click)="onClose()"></ion-icon>
</ion-item>

<div class="filter-content">
  <app-report-stepper [step]="step" *ngIf="!isTest"></app-report-stepper>
  <ng-container *ngIf="step == 1">
    <app-report-asset [workorder]="workorder" [selectedTasks]="selectedTasks" (onSelectedTaskChange)="onSelectedTaskChange($event)" (onSaveWorkOrderState)="onSaveWorkOrderState()" #stepAsset></app-report-asset>
  </ng-container>
  <ng-container *ngIf="step == 2">
    <app-report-context [tasks]="selectedTasks" (onSaveWorkOrderState)="onSaveWorkOrderState()"></app-report-context>
  </ng-container>
  <ng-container *ngIf="step == 3">
    <app-report-form [tasks]="selectedTasks" (onSaveWorkOrderState)="onSaveWorkOrderState()" 
      (goToNextQuestion)="nextFormQuestion()"
      [reportForm]="reportForm" [isTest]="isTest" #stepForm></app-report-form>
  </ng-container>
  <div *ngIf="step == 3" class="form-questions-count">
    {{getFormQuestionLabel()}}
  </div>
</div>
<div class="report-footer-actions" lines="none">
  <ng-container *ngIf="!isSubmitting">
    <ion-button *ngIf="step == 1 && !workorder.wkoPlanningStartDate" fill="clear" style="float: left;" (click)="onEditTask()" [class.font-mobile]="isMobile">Editer les équipements</ion-button>
    <ion-button *ngIf="step == 1 && workorder.wkoPlanningStartDate" fill="clear" style="float: left;" (click)="onNewAsset()" [class.font-mobile]="isMobile">Créer un patrimoine</ion-button>
    <ion-button *ngIf="step >= 2 && !hasPreviousQuestion && !isTest" fill="clear" style="float: left;" (click)="onBack()" [class.font-mobile]="isMobile">Etape précédente</ion-button>
    <div *ngIf="step >= 2 && !hasPreviousQuestion && isTest"></div>
    <ion-button *ngIf="(step == 1 && selectedTasks && selectedTasks.length > 0) || (step == 2 && selectedTasks && selectedTasks.length > 0 && selectedTasks[0].wtrId)" fill="clear" style="margin-left: auto;" (click)="onNext()" [class.font-mobile]="isMobile" [disabled]="hasXYInvalid">Etape suivante</ion-button>
    <ion-button *ngIf="(step == 3) && hasPreviousQuestion" fill="clear" (click)="previousFormQuestion()" [class.font-mobile]="isMobile">Question précédente</ion-button>
    <ion-button *ngIf="step == 3 && !isSubmit" fill="clear" (click)="nextFormQuestion()" [class.font-mobile]="isMobile">Question suivante</ion-button>
    <ion-button *ngIf="isSubmit && !isTest" fill="clear" (click)="submitForm()" [class.font-mobile]="isMobile">Clôturer</ion-button>
    <ion-fab *ngIf="(step == 1 && hasReportClosed())" class="fab-terminate">
      <ion-fab-button color="danger" (click)="submitForm(true)">
        <ion-icon name="close-outline"></ion-icon>
      </ion-fab-button>
      <div *ngIf="!isMobile" class="fab-terminate-text">
        Clôturer circuit
      </div>
    </ion-fab>
    <ion-fab *ngIf="(step == 3 && !isSubmitting && !this.isTest)" (click)="onGoToFirstStep()" class="fab-return">
      <ion-fab-button color="secondary" size="small">
        <ion-icon name="arrow-undo-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </ng-container>
  <ng-container *ngIf="isSubmitting">
    <ion-item lines="none" style="margin: auto;">
      <ion-spinner name="circular" color="primary" style="margin-right: 10px;"></ion-spinner>
      <ion-label>Clôture en cours...</ion-label>
    </ion-item>
  </ng-container>
</div>
<ion-modal #completeModal id="modal-complete">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Clôture</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form *ngIf="completeModalForm" [formGroup]="completeModalForm">
        <ion-grid>
          <ion-row>
            Réalisation de l'intervention
          </ion-row>
          <ion-row>
            <ion-row>
              <ion-input aria-label="date" labelPlacement="floating" fill="outline" label="Date début *" placeholder="JJ/MM/AAAA"
                formControlName="realisationStartDate" (keydown)="onDateKeyDown($event)" (keyup)="onDateKeyUp($event)"></ion-input>
            </ion-row>
            <ion-row>
              <ion-input aria-label="date" labelPlacement="floating" fill="outline" label="Date fin *" placeholder="JJ/MM/AAAA"
                formControlName="realisationEndDate" (keydown)="onDateKeyDown($event)" (keyup)="onDateKeyUp($event)"></ion-input>
            </ion-row>
            <ion-col size="1">
              <ion-button fill="clear" color="primary" (click)="openCalendar()">
                <ion-icon name="calendar-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-col>
          </ion-row>
          <ion-row>
            <div *ngIf="completeModalForm.hasError('dateCompareInvalid')" class="error-message">
              <ion-note>La date de fin ne peut être inférieure à la date de début</ion-note>
            </div>
          </ion-row>
        </ion-grid>
      </form>
    </ion-content>
    <ion-footer>
      <ion-grid>
        <ion-row class="modal-footer-buttons">
          <ion-button fill="clear" color="primary" (click)="cancelCompleteModal()">
            Annuler
          </ion-button>
          <ion-button fill="clear" color="primary" [disabled]="!completeModalForm.valid" (click)="validCompleteModal()">
              Valider
          </ion-button>
        </ion-row>
      </ion-grid>
    </ion-footer>
  </ng-template>
</ion-modal>